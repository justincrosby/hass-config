# Weather Extract

- trigger:
    - platform: time_pattern
      minutes: /15
    - platform: homeassistant
      event: start

  sensor:
    - name: "Hourly Weather Data"
      unique_id: hourly_weather_data
      state: >
        {% if forecast['weather.pirateweather'].forecast is defined
              and forecast['weather.pirateweather'].forecast | length > 0 %}
          {{ as_local(strptime(forecast['weather.pirateweather'].forecast[0].datetime,
                               '%Y-%m-%dT%H:%M:%S%z')) }}
        {% else %}
          unknown
        {% endif %}
      attributes:
        forecast_data: >
          {% if forecast['weather.pirateweather'].forecast is defined
                and forecast['weather.pirateweather'].forecast | length > 0 %}
            {{ forecast['weather.pirateweather'].forecast[0] }}
          {% else %}
            {}
          {% endif %}

    - name: "Daily Weather Data"
      unique_id: daily_weather_data
      state: >
        {% if forecast_daily['weather.pirateweather'].forecast is defined
              and forecast_daily['weather.pirateweather'].forecast | length > 0 %}
          {{ as_local(strptime(forecast_daily['weather.pirateweather'].forecast[0].datetime,
                               '%Y-%m-%dT%H:%M:%S%z')) }}
        {% else %}
          unknown
        {% endif %}
      attributes:
        forecast_data: >
          {% if forecast_daily['weather.pirateweather'].forecast is defined
                and forecast_daily['weather.pirateweather'].forecast | length > 0 %}
            {{ forecast_daily['weather.pirateweather'].forecast[0] }}
          {% else %}
            {}
          {% endif %}

  action:
    - action: weather.get_forecasts
      target:
        entity_id: weather.pirateweather
      data:
        type: hourly
      response_variable: forecast

    - action: weather.get_forecasts
      target:
        entity_id: weather.pirateweather
      data:
        type: daily
      response_variable: forecast_daily

- trigger:
    - platform: time_pattern
      minutes: /15
    - platform: homeassistant
      event: start

  sensor:
    - name: "Weather Hourly Forecasts (Full Hourly Forecast)"
      unique_id: weather_hourly_forecasts_full_hourly_forecast
      state: >
        {% if forecast['weather.pirateweather'].forecast is defined
              and forecast['weather.pirateweather'].forecast | length > 0 %}
          {{ as_local(strptime(forecast['weather.pirateweather'].forecast[0].datetime,
                               '%Y-%m-%dT%H:%M:%S%z')) }}
        {% else %}
          unknown
        {% endif %}
      attributes:
        forecasts: >
          {% if forecast['weather.pirateweather'].forecast is defined
                and forecast['weather.pirateweather'].forecast | length > 0 %}
            [
            {%- for f in forecast['weather.pirateweather'].forecast %}
              {
                "datetime": "{{ as_local(strptime(f.datetime, '%Y-%m-%dT%H:%M:%S%z')) }}",
                "condition": "{{ f.condition }}",
                "temperature": {{ f.temperature }},
                "precipitation": {{ f.precipitation }},
                "wind_speed": {{ f.wind_speed }},
                "wind_bearing": {{ f.wind_bearing }},
                "humidity": {{ f.humidity if f.humidity is defined else 'null' }},
                "cloud_coverage": {{ f.cloud_coverage if f.cloud_coverage is defined else 'null' }},
                "uv_index": {{ f.uv_index if f.uv_index is defined else 'null' }}
              }{{ "," if not loop.last }}
            {%- endfor %}
            ]
          {% else %}
            []
          {% endif %}

  action:
    - action: weather.get_forecasts
      target:
        entity_id: weather.pirateweather
      data:
        type: hourly
      response_variable: forecast